{{- if .Values.mock.enabled }}
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  annotations:
    {{- with .Values.mock.db.deploymentAnnotations }}
{{ toYaml . | indent 4 }}
    {{- end }}
    image.openshift.io/triggers: |
      [{
        "from": {
          "kind":"ImageStreamTag",
          "name":"{{- if .Values.mock.db.image.stream }}{{ .Values.mock.db.image.name }}:{{ .Values.mock.db.image.tag }}{{- else }}{{ template "psd2.fullname" . }}-mock-db:latest{{- end }}"
        },
        "fieldPath":"spec.template.spec.containers[?(@.name==\"mongo\")].image"
      }]
    checksum/secret: {{ include (print $.Template.BasePath "/mock/mock-secrets.yaml") . | sha256sum }}
  name: {{ template "psd2.fullname" . }}-mongo-db
  labels:
{{ include "psd2.labels" . | indent 4 }}
    app.kubernetes.io/component: mock-db
    app: multibanking-mock
spec:
  serviceName: {{ template "psd2.fullname" . }}-mongo-db
  updateStrategy:
    type: RollingUpdate
  selector:
    matchLabels:
{{ include "psd2.matchLabels" . | indent 6 }}
      app.kubernetes.io/component: mock-db
  replicas: 1
  revisionHistoryLimit: 10
  template:
    metadata:
      labels:
{{ include "psd2.matchLabels" . | indent 8 }}
        app.kubernetes.io/component: mock-db
{{- with .Values.mock.db.podAnnotations }}
      annotations:
{{ toYaml . | indent 8 }}
{{- end }}
    spec:
      containers:
      - name: mongo
        # redhat hack: invalid image to stop first unused deployment
        image: " "
        env:
        - name: TZ
          value: {{ .Values.timezone | quote }}
        - name: MONGODB_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              key: admin-password
              name: {{ template "psd2.fullname" . }}-mock-db
{{- if .Values.mock.db.user }}
        - name: MONGODB_USER
          valueFrom:
            secretKeyRef:
              key: username
              name: {{ template "psd2.fullname" . }}-mock-db
        - name: MONGODB_PASSWORD
          valueFrom:
            secretKeyRef:
              key: password
              name: {{ template "psd2.fullname" . }}-mock-db
        - name: MONGODB_DATABASE
          valueFrom:
            secretKeyRef:
              key: database
              name: {{ template "psd2.fullname" . }}-mock-db
{{- end }}
{{- with .Values.mock.db.extraEnv }}
{{ tpl . $ | indent 8 }}
{{- end }}
        ports:
        - name: mongo
          containerPort: 27017
          protocol: TCP
        resources:
{{ toYaml .Values.mock.db.resources | indent 10 }}
        livenessProbe:
{{ toYaml .Values.mock.db.livenessProbe | indent 10 }}
        readinessProbe:
{{ toYaml .Values.mock.db.readinessProbe | indent 10 }}
{{- if .Values.mock.db.persistence.enabled }}
        volumeMounts:
        - mountPath: {{ default "/var/lib/mongodb/data" .Values.mock.db.persistence.mountPath }}
          name: data
{{- end }}
{{- if .Values.mock.db.persistence.enabled }}
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: [ "ReadWriteOnce" ]
{{- if .Values.mock.db.persistence.storageClass }}
      storageClassName: "{{ .Values.mock.db.persistence.storageClass }}"
{{- end }}
      resources:
        requests:
          storage: {{ .Values.mock.db.persistence.size }}
{{- end }}
{{- end }}
